name: CI/CD for Docker Images

on:
  push:
    branches:
      - release/*
      - dev
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Set Start Time
        id: start_time
        run: echo "START_TIME=$(date +'%d/%m/%Y %H:%M:%S')" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | ðŸ”„ Workflow started for commit: ${{ github.sha }} on branch: ${{ github.ref }}"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Notify Docker Login Status
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âœ… Docker login succeeded"}' ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Docker Login Status
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âŒ Docker login failed"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Determine tag
        id: determine_tag
        run: |
          if [[ "${{ github.ref }}" == refs/heads/master ]]; then
            echo "TAG=latest" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == refs/heads/dev ]]; then
            echo "TAG=dev" >> $GITHUB_ENV
          else
            echo "TAG=${GITHUB_REF#refs/heads/release/}" >> $GITHUB_ENV
          fi

      - name: Build and Push Docker Image (Standard Node.js)
        run: |
          docker build -f Dockerfile -t jsisques/gardenia-backend:${{ env.TAG }} .
          docker push jsisques/gardenia-backend:${{ env.TAG }}
        continue-on-error: true
        id: build-push-standard

      - name: Notify Build and Push Status (Standard Node.js)
        if: steps.build-push-standard.outcome == 'success'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âœ… Built and pushed standard Node.js image successfully"}' ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Build and Push Status (Standard Node.js)
        if: steps.build-push-standard.outcome == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âŒ Failed to build and push standard Node.js image"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Build and Push Docker Image (Alpine Node.js)
        run: |
          docker build -f Dockerfile-alpine -t jsisques/gardenia-backend:alpine-${{ env.TAG }} .
          docker push jsisques/gardenia-backend:alpine-${{ env.TAG }}
        continue-on-error: true
        id: build-push-alpine

      - name: Notify Build and Push Status (Alpine Node.js)
        if: steps.build-push-alpine.outcome == 'success'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âœ… Built and pushed Alpine Node.js image successfully"}' ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

      - name: Notify Build and Push Status (Alpine Node.js)
        if: steps.build-push-alpine.outcome == 'failure'
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.START_TIME }} | âŒ Failed to build and push Alpine Node.js image"}' ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Set End Time
        id: end_time
        run: echo "END_TIME=$(date +'%d/%m/%Y %H:%M:%S')" >> $GITHUB_ENV

      - name: Calculate Duration
        id: duration
        run: |
          START=$(date -d "${{ env.START_TIME }}" +%s)
          END=$(date -d "${{ env.END_TIME }}" +%s)
          DURATION=$((END - START))
          echo "DURATION=$DURATION" >> $GITHUB_ENV
          echo "Duration in seconds: $DURATION"

      - name: Notify Completion
        if: success() || failure()
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{"text":"${{ env.END_TIME }} | âœ… Workflow completed for commit: ${{ github.sha }} on branch: ${{ github.ref }} with status: ${{ job.status }}. Total execution time: $((DURATION / 60)) minutes and $((DURATION % 60)) seconds."}' ${{ secrets.SLACK_WEBHOOK_URL }}
